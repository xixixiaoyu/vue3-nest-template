# 部署最佳实践

<cite>
**本文档引用的文件**
- [nginx.conf](file://apps/frontend/nginx.conf)
- [Dockerfile](file://apps/frontend/Dockerfile)
- [docker-compose.yml](file://docker-compose.yml)
- [README.md](file://README.md)
</cite>

## 目录
1. [简介](#简介)
2. [Nginx 反向代理与负载均衡配置](#nginx-反向代理与负载均衡配置)
3. [SSL/TLS 证书集成](#ssl/tls-证书集成)
4. [监控与日志策略](#监控与日志策略)
5. [高可用性与部署策略](#高可用性与部署策略)
6. [安全加固建议](#安全加固建议)
7. [性能调优技巧](#性能调优技巧)

## 简介
本项目是一个基于 NestJS 和 Vue 3 的全栈应用模板，采用 pnpm Monorepo 架构。项目通过 Docker Compose 进行容器编排，前端使用 Nginx 作为反向代理服务器，后端使用 Node.js 运行 NestJS 应用。本文档旨在提供生产环境部署的高级最佳实践，涵盖 Nginx 配置、SSL/TLS 证书集成、监控与日志策略、高可用性部署、安全加固和性能调优等方面。

**Section sources**
- [README.md](file://README.md#L3-L16)

## Nginx 反向代理与负载均衡配置
Nginx 在本项目中作为前端静态资源的反向代理和负载均衡器。通过 `nginx.conf` 文件配置，实现了 gzip 压缩、缓存头设置和 HTTPS 重定向等功能。

### Gzip 压缩
Gzip 压缩可以显著减少传输数据的大小，提高页面加载速度。在 `nginx.conf` 中，通过以下配置启用 Gzip 压缩：

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_proxied expired no-cache no-store private auth;
gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript application/json;
```

这些配置确保了文本、CSS、JavaScript 和 JSON 等资源在传输时被压缩，从而减少带宽消耗和提高响应速度。

### 缓存头设置
为了提高前端资源的加载速度，Nginx 配置了静态资源的缓存策略。在 `nginx.conf` 中，通过以下配置设置缓存头：

```nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    access_log off;
}
```

这些配置确保了静态资源在客户端浏览器中被长期缓存，减少了重复请求，提高了用户体验。

### HTTPS 重定向
为了确保数据传输的安全性，Nginx 配置了 HTTPS 重定向。虽然 `nginx.conf` 文件中没有直接配置 HTTPS 重定向，但可以通过在 `docker-compose.yml` 文件中配置 Nginx 容器的端口映射来实现：

```yaml
frontend:
  build:
    context: .
    dockerfile: apps/frontend/Dockerfile
  container_name: myapp-frontend
  restart: unless-stopped
  ports:
    - '80:80'
    - '443:443'
  depends_on:
    backend:
      condition: service_healthy
  healthcheck:
    test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:80/health']
    interval: 30s
    timeout: 10s
    start_period: 5s
    retries: 3
  networks:
    - myapp-network
```

通过将 443 端口映射到主机，可以配置 Nginx 服务器以支持 HTTPS，并在配置文件中添加相应的 SSL 证书和密钥路径。

**Section sources**
- [nginx.conf](file://apps/frontend/nginx.conf#L7-L12)
- [nginx.conf](file://apps/frontend/nginx.conf#L45-L50)
- [docker-compose.yml](file://docker-compose.yml#L81-L99)

## SSL/TLS 证书集成
为了确保数据传输的安全性，建议使用 Let's Encrypt 提供的免费 SSL/TLS 证书。Let's Encrypt 是一个自动化的、开放的证书颁发机构，可以轻松地为网站提供 SSL/TLS 证书。

### 申请 Let's Encrypt 证书
1. **安装 Certbot**：Certbot 是 Let's Encrypt 的官方客户端，可以自动申请和续期证书。
   ```bash
   sudo apt-get update
   sudo apt-get install certbot python3-certbot-nginx
   ```

2. **申请证书**：使用 Certbot 申请证书，并自动配置 Nginx。
   ```bash
   sudo certbot --nginx -d your-domain.com
   ```

3. **自动续期**：Certbot 会自动配置定时任务，定期检查证书的有效期并自动续期。
   ```bash
   sudo certbot renew --dry-run
   ```

### 配置 Nginx 使用 SSL 证书
在 `nginx.conf` 文件中，添加以下配置以启用 HTTPS：

```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;

    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    location / {
        proxy_pass http://backend:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

这些配置确保了 Nginx 服务器使用 SSL/TLS 证书，提供安全的 HTTPS 连接。

**Section sources**
- [nginx.conf](file://apps/frontend/nginx.conf#L1-L59)

## 监控与日志策略
为了确保系统的稳定性和可维护性，建议使用 Prometheus/Grafana 或 ELK Stack 进行系统监控。

### Prometheus/Grafana
Prometheus 是一个开源的监控系统，Grafana 是一个开源的可视化工具。通过 Prometheus 收集系统指标，Grafana 进行可视化展示。

1. **安装 Prometheus 和 Grafana**：
   ```bash
   docker run -d -p 9090:9090 prom/prometheus
   docker run -d -p 3000:3000 grafana/grafana
   ```

2. **配置 Prometheus**：在 `prometheus.yml` 文件中配置数据源。
   ```yaml
   scrape_configs:
     - job_name: 'node'
       static_configs:
         - targets: ['localhost:9090']
   ```

3. **配置 Grafana**：在 Grafana 中添加 Prometheus 数据源，并创建仪表板。

### ELK Stack
ELK Stack 由 Elasticsearch、Logstash 和 Kibana 组成，用于日志的收集、处理和可视化。

1. **安装 ELK Stack**：
   ```bash
   docker-compose up -d
   ```

2. **配置 Logstash**：在 `logstash.conf` 文件中配置日志输入和输出。
   ```conf
   input {
     file {
       path => "/var/log/nginx/*.log"
       start_position => "beginning"
     }
   }

   output {
     elasticsearch {
       hosts => ["http://elasticsearch:9200"]
       index => "nginx-%{+YYYY.MM.dd}"
     }
   }
   ```

3. **配置 Kibana**：在 Kibana 中添加 Elasticsearch 数据源，并创建可视化仪表板。

**Section sources**
- [README.md](file://README.md#L363-L369)

## 高可用性与部署策略
为了确保系统的高可用性，建议采用蓝绿部署或金丝雀发布策略。

### 蓝绿部署
蓝绿部署是一种零停机部署策略，通过两个独立的环境（蓝色和绿色）来实现无缝切换。

1. **准备两个环境**：一个用于生产（蓝色），一个用于新版本（绿色）。
2. **部署新版本**：将新版本部署到绿色环境。
3. **测试新版本**：在绿色环境中进行充分测试。
4. **切换流量**：通过负载均衡器将流量从蓝色环境切换到绿色环境。
5. **回滚**：如果新版本出现问题，可以快速切换回蓝色环境。

### 金丝雀发布
金丝雀发布是一种逐步发布新版本的策略，通过将新版本逐步暴露给一小部分用户来降低风险。

1. **部署新版本**：将新版本部署到生产环境，但只对一小部分用户开放。
2. **监控新版本**：密切监控新版本的性能和用户反馈。
3. **逐步扩大范围**：如果新版本表现良好，逐步扩大用户范围。
4. **完全发布**：当新版本稳定后，对所有用户开放。

**Section sources**
- [README.md](file://README.md#L380-L427)

## 安全加固建议
为了确保系统的安全性，建议采取以下措施：

### 最小权限原则
- **用户权限**：为每个用户分配最小必要的权限，避免过度授权。
- **服务账户**：为每个服务创建独立的服务账户，限制其权限范围。

### 定期镜像更新
- **定期更新**：定期更新 Docker 镜像，确保使用最新的安全补丁。
- **自动化更新**：使用 CI/CD 工具自动化镜像更新流程。

### 漏洞扫描
- **定期扫描**：使用漏洞扫描工具定期扫描系统，发现潜在的安全问题。
- **修复漏洞**：及时修复发现的漏洞，确保系统安全。

**Section sources**
- [README.md](file://README.md#L353-L362)

## 性能调优技巧
为了提高系统的性能，建议采取以下措施：

### 数据库连接池配置
- **连接池大小**：根据应用的并发需求，合理配置数据库连接池的大小。
- **连接超时**：设置合理的连接超时时间，避免长时间占用连接。

### Redis 缓存策略
- **缓存键前缀**：使用缓存键前缀管理不同类型的缓存数据。
- **过期时间**：为缓存数据设置合理的过期时间，避免缓存数据过期不及时。

### 前端资源优化
- **资源压缩**：使用 Gzip 压缩前端资源，减少传输数据的大小。
- **缓存策略**：合理设置缓存头，提高前端资源的加载速度。

**Section sources**
- [README.md](file://README.md#L380-L427)
- [nginx.conf](file://apps/frontend/nginx.conf#L7-L12)
- [nginx.conf](file://apps/frontend/nginx.conf#L45-L50)