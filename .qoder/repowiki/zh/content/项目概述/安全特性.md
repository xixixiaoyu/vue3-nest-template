# 安全特性

<cite>
**本文档引用的文件**   
- [main.ts](file://apps/backend/src/main.ts)
- [app.module.ts](file://apps/backend/src/app.module.ts)
- [auth.service.ts](file://apps/backend/src/auth/auth.service.ts)
- [auth.controller.ts](file://apps/backend/src/auth/auth.controller.ts)
- [jwt.strategy.ts](file://apps/backend/src/auth/jwt.strategy.ts)
- [csrf.middleware.ts](file://apps/backend/src/common/middlewares/csrf.middleware.ts)
- [sanitize.interceptor.ts](file://apps/backend/src/common/interceptors/sanitize.interceptor.ts)
- [all-exceptions.filter.ts](file://apps/backend/src/common/filters/all-exceptions.filter.ts)
- [auth.module.ts](file://apps/backend/src/auth/auth.module.ts)
- [nginx.conf](file://apps/frontend/nginx.conf)
- [auth.dto.ts](file://apps/backend/src/auth/auth.dto.ts)
- [RegisterView.vue](file://apps/frontend/src/views/RegisterView.vue)
- [ForgotPasswordView.vue](file://apps/frontend/src/views/ForgotPasswordView.vue)
- [ResetPasswordView.vue](file://apps/frontend/src/views/ResetPasswordView.vue)
- [auth.schema.ts](file://packages/shared/src/schemas/auth.schema.ts)
</cite>

## 更新摘要
**变更内容**   
- 更新了认证与授权流程，新增用户注册、密码重置和账户恢复功能
- 扩展认证流程图以包含完整的用户生命周期管理
- 新增用户注册、找回密码、重置密码等API接口说明
- 更新认证流程序列图，反映完整的用户生命周期

## 目录
1. [安全防护机制](#安全防护机制)
2. [认证与授权](#认证与授权)
3. [速率限制策略](#速率限制策略)
4. [输入验证与清理](#输入验证与清理)
5. [安全头与CORS配置](#安全头与cors配置)
6. [异常处理与日志](#异常处理与日志)

## 安全防护机制

本项目采用多层次的安全防护机制，确保应用在生产环境中的安全性。通过集成多种安全中间件和防护策略，有效抵御常见的Web攻击。

```mermaid
graph TD
A[客户端请求] --> B[Helmet安全头]
B --> C[CORS跨域配置]
C --> D[CSRF保护]
D --> E[输入数据清理]
E --> F[速率限制]
F --> G[JWT认证]
G --> H[业务逻辑处理]
H --> I[标准化响应]
```

**图表来源**
- [main.ts](file://apps/backend/src/main.ts#L24-L37)
- [app.module.ts](file://apps/backend/src/app.module.ts#L155-L157)
- [csrf.middleware.ts](file://apps/backend/src/common/middlewares/csrf.middleware.ts#L15-L93)

## 认证与授权

系统采用双令牌机制（accessToken + refreshToken）进行用户认证，确保会话安全。认证流程通过JWT（JSON Web Token）实现，结合Passport策略进行权限验证。现已扩展支持完整的用户生命周期管理，包括用户注册、密码重置和账户恢复功能。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant AuthController as "认证控制器"
participant AuthService as "认证服务"
participant JwtStrategy as "JWT策略"
Client->>AuthController : POST /api/auth/register
AuthController->>AuthService : 创建新用户
AuthService->>AuthService : 哈希密码并保存用户
AuthService-->>AuthController : 返回认证结果
AuthController-->>Client : {accessToken, refreshToken, user}
Client->>AuthController : POST /api/auth/forgot-password
AuthController->>AuthService : 请求密码重置
AuthService->>AuthService : 生成重置令牌并发送邮件
AuthService-->>AuthController : 操作完成
AuthController-->>Client : 确认消息
Client->>AuthController : POST /api/auth/reset-password
AuthController->>AuthService : 重置密码
AuthService->>AuthService : 验证令牌并更新密码
AuthService-->>AuthController : 操作完成
AuthController-->>Client : 成功消息
Client->>AuthController : POST /api/auth/login
AuthController->>AuthService : 验证用户凭据
AuthService->>AuthService : 查询用户并验证密码
AuthService-->>AuthController : 返回认证结果
AuthController-->>Client : {accessToken, refreshToken, user}
Client->>AuthController : GET /api/auth/me
AuthController->>JwtStrategy : 验证JWT令牌
JwtStrategy->>AuthService : 根据ID获取用户信息
AuthService-->>JwtStrategy : 用户信息
JwtStrategy-->>AuthController : 通过验证
AuthController-->>Client : 用户信息
```

**图表来源**
- [auth.controller.ts](file://apps/backend/src/auth/auth.controller.ts#L38-L90)
- [auth.service.ts](file://apps/backend/src/auth/auth.service.ts#L160-L260)
- [jwt.strategy.ts](file://apps/backend/src/auth/jwt.strategy.ts#L17-L47)
- [auth.dto.ts](file://apps/backend/src/auth/auth.dto.ts#L14-L35)
- [auth.schema.ts](file://packages/shared/src/schemas/auth.schema.ts#L24-L113)

**本节来源**
- [auth.service.ts](file://apps/backend/src/auth/auth.service.ts#L26-L260)
- [auth.controller.ts](file://apps/backend/src/auth/auth.controller.ts#L18-L90)
- [jwt.strategy.ts](file://apps/backend/src/auth/jwt.strategy.ts#L17-L47)
- [auth.dto.ts](file://apps/backend/src/auth/auth.dto.ts#L14-L35)
- [auth.schema.ts](file://packages/shared/src/schemas/auth.schema.ts#L24-L113)

### 用户注册
新增用户注册功能，通过`POST /api/auth/register`接口实现。系统会对用户输入的邮箱进行唯一性检查，使用bcrypt对密码进行哈希处理后存储。为防止用户枚举攻击，注册时不会明确提示邮箱是否已存在。

**本节来源**
- [auth.controller.ts](file://apps/backend/src/auth/auth.controller.ts#L38-L44)
- [auth.service.ts](file://apps/backend/src/auth/auth.service.ts#L160-L189)
- [RegisterView.vue](file://apps/frontend/src/views/RegisterView.vue)

### 密码重置流程
实现完整的密码重置流程，包含三个阶段：请求重置、邮件发送、密码更新。用户通过`POST /api/auth/forgot-password`请求重置，系统生成SHA256哈希的重置令牌并存储过期时间（1小时），然后发送包含唯一令牌的重置链接到用户邮箱。

**本节来源**
- [auth.controller.ts](file://apps/backend/src/auth/auth.controller.ts#L72-L78)
- [auth.service.ts](file://apps/backend/src/auth/auth.service.ts#L194-L220)
- [mail.service.ts](file://apps/backend/src/mail/mail.service.ts#L64-L80)
- [ForgotPasswordView.vue](file://apps/frontend/src/views/ForgotPasswordView.vue)

### 重置密码
用户通过点击邮件中的链接访问重置页面，提交新密码和令牌。系统验证令牌的有效性和过期时间，验证通过后更新密码并清除重置令牌。重置链接有效期为1小时，且使用后立即失效。

**本节来源**
- [auth.controller.ts](file://apps/backend/src/auth/auth.controller.ts#L84-L90)
- [auth.service.ts](file://apps/backend/src/auth/auth.service.ts#L225-L251)
- [ResetPasswordView.vue](file://apps/frontend/src/views/ResetPasswordView.vue)

## 速率限制策略

系统配置了三级速率限制策略，有效防止暴力破解和DDoS攻击。通过ThrottlerGuard实现全局速率控制，并针对不同接口设置特定限制。

| 级别 | 时间窗口 | 最大请求数 | 说明 |
|------|----------|------------|------|
| 短期 | 1秒 | 3次 | 防止暴力破解 |
| 中期 | 10秒 | 20次 | 正常使用限制 |
| 长期 | 1分钟 | 100次 | 整体流量控制 |

```mermaid
flowchart TD
Start([请求到达]) --> CheckRate["检查速率限制"]
CheckRate --> RateLimit{"超过限制?"}
RateLimit --> |是| Return429["返回429状态码"]
RateLimit --> |否| ProcessRequest["处理请求"]
ProcessRequest --> End([返回响应])
Return429 --> End
```

**图表来源**
- [app.module.ts](file://apps/backend/src/app.module.ts#L113-L134)
- [auth.controller.ts](file://apps/backend/src/auth/auth.controller.ts#L23-L34)

**本节来源**
- [app.module.ts](file://apps/backend/src/app.module.ts#L113-L134)
- [auth.controller.ts](file://apps/backend/src/auth/auth.controller.ts#L23-L34)

## 输入验证与清理

系统采用Zod Schema进行输入验证，并通过XSS清理拦截器防止跨站脚本攻击。所有用户输入都会经过严格的验证和清理流程。新增的注册和密码重置功能均使用共享的Zod Schema进行验证。

```mermaid
flowchart TD
A[用户输入] --> B{Zod验证管道}
B --> |验证失败| C[返回400错误]
B --> |验证通过| D[XSS清理拦截器]
D --> E[递归清理对象]
E --> F[移除HTML标签]
F --> G[安全方法比较]
G --> H[业务逻辑处理]
subgraph XSS清理
E --> E1["字符串: sanitizeHtml"]
E --> E2["数组: 递归映射"]
E --> E3["对象: 递归处理"]
end
```

**图表来源**
- [main.ts](file://apps/backend/src/main.ts#L66-L72)
- [sanitize.interceptor.ts](file://apps/backend/src/common/interceptors/sanitize.interceptor.ts#L10-L61)
- [auth.schema.ts](file://packages/shared/src/schemas/auth.schema.ts#L24-L113)

**本节来源**
- [main.ts](file://apps/backend/src/main.ts#L66-L72)
- [sanitize.interceptor.ts](file://apps/backend/src/common/interceptors/sanitize.interceptor.ts#L1-L61)
- [auth.schema.ts](file://packages/shared/src/schemas/auth.schema.ts#L24-L113)

## 安全头与CORS配置

通过Helmet中间件设置安全头，并配置CORS策略，增强应用的安全性。同时在Nginx层面也配置了相应的安全头。

```mermaid
graph LR
A[Helmet] --> B[内容安全策略]
A --> C[点击劫持防护]
A --> D[XSS防护]
A --> E[框架选项]
F[CORS] --> G[允许来源]
F --> H[允许方法]
F --> I[允许头部]
F --> J[凭证支持]
K[Nginx] --> L[安全头设置]
K --> M[内容安全策略]
K --> N[权限策略]
```

**图表来源**
- [main.ts](file://apps/backend/src/main.ts#L25-L37)
- [main.ts](file://apps/backend/src/main.ts#L58-L63)
- [nginx.conf](file://apps/frontend/nginx.conf#L55-L65)

**本节来源**
- [main.ts](file://apps/backend/src/main.ts#L25-L37)
- [main.ts](file://apps/backend/src/main.ts#L58-L63)
- [nginx.conf](file://apps/frontend/nginx.conf#L55-L65)

## 异常处理与日志

系统实现了全局异常过滤器，统一处理所有未捕获的异常，并返回标准化的错误响应格式。同时配置了详细的日志记录。

```mermaid
flowchart TD
A[异常抛出] --> B{异常类型}
B --> |HttpException| C[获取状态码和消息]
B --> |其他异常| D[内部服务器错误]
C --> E[构建标准响应]
D --> E
E --> F[记录错误日志]
F --> G[返回JSON响应]
subgraph 响应结构
G --> H["{success: false, data: null, message, statusCode, timestamp}"]
end
```

**图表来源**
- [all-exceptions.filter.ts](file://apps/backend/src/common/filters/all-exceptions.filter.ts#L8-L31)
- [main.ts](file://apps/backend/src/main.ts#L68-L69)

**本节来源**
- [all-exceptions.filter.ts](file://apps/backend/src/common/filters/all-exceptions.filter.ts#L1-L31)
- [main.ts](file://apps/backend/src/main.ts#L68-L69)